Parameters:
	SnapshotToRestore:
		Type: String
		Default: ""
		Description: Snapshot id to restore DB. leave blank if you are going to start a fresh install
	EnvironmentSize:
		Type: String
		Default: SMALL
		AllowedValues:
			- SMALL
			- MEDIUM
			- LARGE
		Description: Select and environment size (S,M,L) Large environments will deploy an aurora cluster
	DatabaseName:
		Type: String
		Default: MoodleDB
		MinLength: 8
		MaxLength: 64
		AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*" # Start with a letter, alphanumeric characters only
	DatabaseUser:
		Type: String
		Default: moodledude
		MinLength: 8
		MaxLength: 16
		AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*" # Start with a letter, alphanumeric characters only
	DatabasePassword:
		Type: String
		Default: moodledudepassword
		MinLength: 8
		MaxLength: 41
		NoEcho: true
		AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*" # Start with a letter, alphanumeric Characters only
Conditions:
	isLarge:
		!Equals [!Ref EnvironmentSize, "LARGE"]
	isntLarge:
		!Not [!Equals [!Ref EnvironmentSize. "LARGE"]]
	isRestore:
		!Not [!Equals [!Ref SnapshotToRestore, ""]]
Mappings:
	RegionMap:
		us-east-1:
      			"UBUNTU" : "ami-1d4e7a66" # Ubuntu Aug 2017
    		us-east-2:
      			"UBUNTU" : "ami-dbbd9dbe" # Ubuntu Aug 2017
    		us-west-1:
      			"UBUNTU" : "ami-969ab1f6" # Ubuntu Aug 2017
    		us-west-2:
      			"UBUNTU" : "ami-8803e0f0" # Ubuntu Aug 2017
    		ca-central-1:
      			"UBUNTU" : "ami-a9c27ccd" # Ubuntu Aug 2017
    		eu-west-1:
      			"UBUNTU" : "ami-674cbc1e" # Ubuntu Aug 2017
	    	eu-central-1:
      			"UBUNTU" : "ami-958128fa" # Ubuntu Aug 2017
    		eu-west-2:
      			"UBUNTU" : "ami-03998867" # Ubuntu Aug 2017
    		ap-southeast-1:
      			"UBUNTU" : "ami-9f28b3fc" # Ubuntu Aug 2017
    		ap-southeast-2:
      			"UBUNTU" : "ami-bb1901d8" # Ubuntu Aug 2017
    		ap-northeast-2:
      			"UBUNTU" : "ami-536ab33d" # Ubuntu Aug 2017
    		ap-northeast-1:
      			"UBUNTU" : "ami-0417e362" # Ubuntu Aug 2017
    		ap-south-1:
      			"UBUNTU" : "ami-df413bb0" # Ubuntu Aug 2017
    		sa-east-1:
      			"UBUNTU" : "ami-a41869c8" # Ubuntu Aug 2017

	InstanceSize:
		SMALL:
			"EC2": "t2.micro" 
			"DB" : "db.t2.micro"
		MEDIUM:
			"EC2": "t2.small"
			"DB" : "db.t2.small"
		LARGE:
			"EC2": "t2.medium"
			"DB" : "db.r3.xlarge"
Resources:
  ELB:
     Type:
     Properties:
  EC2:
     Type: "AWS::EC2::Instance"
     Properties:
	 ImageId:
	 InstanceType:
  DB:
    Type: "AWS::RDS::DBInstance"
    DeletionPolicy: Snapshot
    Properties:
       AllocatedStorage: 5
       StorageType: gp2
       DBInstanceClass:
       Engine: MySQL
       MasterUserName:
       MasterUserPassword:
  DBAuroraCluster:
	Type: "AWS::RDS::DBCluster"
	DeletionPolicy: Snapshot
	Condition:
	Properties:
		DataBaseName:
		Engine: Aurora
		MasterUserName:
		MasterUserPassword:
		SnapshotIdentifier:
  DBAurora:
	Type:
	Condition:
	Properties:
		DBClusterIdentifier: !Ref DBAuroraCluster
		Engine: Aurora
		DBInstanceClass: !FinInMap [InstanceSize, !Ref Environmentsize, DB]
  S3:
    Type: "AWS::S3::Bucket"
    DeletionPolicy: Retain
Outputs:
	
